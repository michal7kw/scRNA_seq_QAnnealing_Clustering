---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---


# Libraries
```{r warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(Seurat)
library(ggplot2)
library(bspec)
library(sctransform)
library(cowplot)
library(gridExtra)
library(dplyr)
library(patchwork)
library(sctransform)
library(glmGamPoi)
```

# Evaluation of clustering on QA

## subsetting and preprocessing
### subsetting
```{r}
pbmc3k <- readRDS(file = "data/pbmc_data/pbmc3k/pbmc3k_init.rds")
pbmc3k[["percent.mt"]] <- PercentageFeatureSet(pbmc3k, pattern = "^MT-")
pbmc3k <- subset(pbmc3k, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
VlnPlot(pbmc3k, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

plot1 <- FeatureScatter(pbmc3k, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc3k, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2

# pbmc3k_QA <- pbmc3k
# pbmc3k_QA <- pbmc3k[,1:512]
# pbmc3k_QA <- pbmc3k[,1:256]
pbmc3k_QA <- pbmc3k[,1:128]
```

```{r}
pbmc3k_QA <- SCTransform(pbmc3k_QA, method = "glmGamPoi", vars.to.regress = "percent.mt", verbose = FALSE)

pbmc3k_QA <- RunPCA(pbmc3k_QA, features = VariableFeatures(object = pbmc3k_QA))
ElbowPlot(pbmc3k_QA)
DimPlot(pbmc3k_QA, reduction = "pca")
```

### Neighbours evaluation, SNN
```{r}
n = ncol(pbmc3k_QA)
dim(pbmc3k_QA)

type = c("_", "_trimmed_", "_negedges_", "_trimmed_negedges_")
id_type = 2
dim = 15
k = 5
coff = 1/15
ord = 8

pbmc3k_QA <- FindNeighbors(pbmc3k_QA, reduction = "pca", dims = 1:dim, k.param=k, prune.SNN=coff, compute.SNN=TRUE)

pbmc3k_QA_snn <- pbmc3k_QA@graphs[["SCT_snn"]]
# pbmc3k_QA_knn <- pbmc3k_QA@graphs[["SCT_nn"]]

dim(pbmc3k_QA_snn)
pbmc3k_QA_snn <- pbmc3k_QA_snn - diag(n)

# head(pbmc3k_QA_snn)

if (id_type==1 || id_type==2){
  # --- only positive edges ---
  pbmc3k_QA_snn <- round(pbmc3k_QA_snn, digits=2)
} else {
  # --- also negative edges ---
  pbmc3k_QA_snn <- round(pbmc3k_QA_snn, digits=2)
  less_than <- pbmc3k_QA_snn < 0.16 & pbmc3k_QA_snn != 0
  pbmc3k_QA_snn[less_than] <- -0.3
}

# --- dealing with outliers ---
# outlier <- colSums(pbmc3k_QA_snn!=0)==0
# length(outlier)
# sum(outlier, na.rm = TRUE)
# 
# dim(pbmc3k_QA_snn)
# pbmc3k_QA_snn <- pbmc3k_QA_snn[,!outlier]
# pbmc3k_QA_snn <- pbmc3k_QA_snn[!outlier,]
# 
# refference <- colnames(pbmc3k_QA_snn)
colSums(pbmc3k_QA_snn != 0)
# rowSums(pbmc3k_QA_snn != 0)
```

### trimming
```{r}
for (i in 1:n){
  to_delete <- order(pbmc3k_QA_snn[,i], decreasing = TRUE)[seq(ord+1,n,1)]
  pbmc3k_QA_snn[,i][to_delete] <- integer(n-ord)
  pbmc3k_QA_snn[i,][to_delete] <- integer(n-ord)
}
colSums(pbmc3k_QA_snn != 0)
rowSums(pbmc3k_QA_snn != 0)
```

### Plotting
```{r setup}
library(reticulate)
virtualenv_create("scrna_proj")
# py_install(c("networkx","matplotlib"), envname = "scrna_proj")
use_virtualenv("scrna_proj")
```

```{python}
import numpy as np
import networkx as nx
from matplotlib import pyplot as plt

id_type, type = int(r.id_type)-1, r.type
n = int(r.n)
k = int(r.k)
ord = int(r.ord)
dim = int(r.dim)


file_name = ''.join(["./graphs/", str(n), "_graph_snn", "_k", str(k), "_dim", str(dim), type[id_type], str(ord), ".gexf"])

G = nx.from_numpy_matrix(r.pbmc3k_QA_snn)
nx.write_gexf(G, file_name)

# len(G.edges())
# G.degree()

G = nx.read_gexf(file_name)
pos = nx.spring_layout(G)
plt.cla()
nx.draw_networkx_nodes(G, pos, node_size=10, nodelist=G.nodes)
nx.draw_networkx_edges(G, pos, edgelist=G.edges, style='solid', alpha=0.5, width=1)

file_name = ''.join(["./graphs/", str(n), "_graph_snn", "_k", str(k), "_dim", str(dim), type[id_type], str(ord), ".png"])
plt.savefig(file_name, bbox_inches='tight')
```


## Comparing clusters

### importing generated QA clusters

```{python}
import networkx as nx
# QA_output_name = "final_graph_snn (2).gexf"
# QA_output_name = "128_graph_snn_k5_dim15_15.gexf"
QA_output_name = "128_graph_snn_k5_dim15_g0_trimmed_15clean_out.gexf"
QA_clusters = nx.read_gexf(''.join(["./dataIn/", QA_output_name]))

x, y = list(QA_clusters.nodes(data=True))[1]
last = sorted(y.keys())[-1]
y[last] # return value of the last cluster

# sorted(QA_clusters.nodes(data=True))

QA_clusters_ord = nx.convert_node_labels_to_integers(QA_clusters, first_label=1)
# sorted(QA_clusters_ord.nodes)
len(QA_clusters_ord.nodes)
```

```{python}
# print(QA_clusters.nodes(data=True))
colors = [y[sorted(y.keys())[-1]] for x,y in sorted(QA_clusters_ord.nodes(data=True))]
# colors
len(colors)
```

### Preparation of subset
```{r}
pbmc3k <- readRDS(file = "data/pbmc_data/pbmc3k/pbmc3k_init.rds")
pbmc3k[["percent.mt"]] <- PercentageFeatureSet(pbmc3k, pattern = "^MT-")
pbmc3k <- subset(pbmc3k, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)

# pbmc3k_QA <- pbmc3k
# pbmc3k_QA <- pbmc3k[,1:512]
# pbmc3k_QA <- pbmc3k[,1:256]
pbmc3k_QA <- pbmc3k[,1:128]
```

```{r}
pbmc3k_QA <- SCTransform(pbmc3k_QA, method = "glmGamPoi", vars.to.regress = "percent.mt", verbose = FALSE)

pbmc3k_QA <- RunPCA(pbmc3k_QA, features = VariableFeatures(object = pbmc3k_QA))
ElbowPlot(pbmc3k_QA)
DimPlot(pbmc3k_QA, reduction = "pca")
pbmc3k_QA <- FindNeighbors(pbmc3k_QA, reduction = "pca")
```

### Merging of MetaData
```{r}
colors = py$colors
pbmc3k_QA <- AddMetaData(pbmc3k_QA, metadata=colors, col.name="QA")
```

```{r}
DimPlot(pbmc3k_QA, reduction = "pca", group.by="QA")
```

```{r}
pbmc3k_QA <- FindClusters(pbmc3k_QA, verbose = FALSE, resolution = 0.8, algorithm = 1)
pbmc3k_QA <- RunUMAP(pbmc3k_QA, dim=1:15)

png(file="./output/2_128_clusters_QA.png")
DimPlot(pbmc3k_QA, reduction = "umap", group.by="QA") # + NoLegend()
dev.off()

png(file="./output/2_128_clusters_Clasic.png")
DimPlot(pbmc3k_QA, reduction = "umap", group.by="seurat_clusters") # + NoLegend()
dev.off()

DimPlot(pbmc3k_QA, reduction = "umap", group.by="QA") # + NoLegend()
DimPlot(pbmc3k_QA, reduction = "umap", group.by="seurat_clusters") # + NoLegend()
```

### Look for the Marker genes
```{r}
Idents(pbmc3k_QA) <- pbmc3k_QA$seurat_clusters

Classic_pbmc3k_QA_markers <- FindAllMarkers(pbmc3k_QA, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0)
Classic_pbmc3k_QA_top_2 <- Classic_pbmc3k_QA_markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC)
  
print(Classic_pbmc3k_QA_top_2$gene,n=nrow(Classic_pbmc3k_QA_markers$gene))
```

```{r}
Idents(pbmc3k_QA) <- pbmc3k_QA$QA

QA_pbmc3k_QA_markers <- FindAllMarkers(pbmc3k_QA, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0)
QA_pbmc3k_QA_top_2 <- QA_pbmc3k_QA_markers %>%
    group_by(cluster) %>%
    slice_max(n = 2, order_by = avg_log2FC)
  
print(QA_pbmc3k_QA_top_2$gene,n=nrow(QA_pbmc3k_QA_markers$gene))
```

```{r}
png(file="./output/2_Classic_markers.png", width = 1920, height = 1080)
FeaturePlot(pbmc3k_QA, features = c(Classic_pbmc3k_QA_top_2$gene)) + ggtitle("Classic_markers")
dev.off()

png(file="./output/2_QA_markers.png", width = 1920, height = 1080)
FeaturePlot(pbmc3k_QA, features = c(QA_pbmc3k_QA_top_2$gene)) + ggtitle("QA_markers")
dev.off()

FeaturePlot(pbmc3k_QA, features = c(QA_pbmc3k_QA_top_2$gene)) + ggtitle("QA_markers")
```

### annotation
```{r}
library(SingleR)
monaco.ref<- celldex::MonacoImmuneData()
sce <- as.SingleCellExperiment(DietSeurat(pbmc3k_QA))

monaco.main_log <- SingleR(test = sce,assay.type.test = 1,ref = monaco.ref,labels = monaco.ref$label.main)

monaco.fine_log <- SingleR(test = sce,assay.type.test = 1,ref = monaco.ref,labels = monaco.ref$label.fine)
```

```{r}
table(monaco.main_log$pruned.labels)
```

```{r}
table(monaco.fine_log$pruned.labels)
```

```{r}
pbmc3k_QA@meta.data$monaco.main <- monaco.main_log$pruned.labels
pbmc3k_QA@meta.data$monaco.fine <- monaco.fine_log$pruned.labels
```

```{r}
pbmc3k_QA <- SetIdent(pbmc3k_QA, value = "monaco.main")

png(file="./output/pbmc3k_QA_cell_types.png", width = 720, height = 480)
DimPlot(pbmc3k_QA, label = T , repel = T, label.size = 8) + NoLegend() + ggtitle("pbmc3k_QA_cell_type")
dev.off()

DimPlot(pbmc3k_QA, label = T , repel = T, label.size = 8) + NoLegend() + ggtitle("pbmc3k_QA_cell_type")
```